<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상품 목록(검색)</title>
    <link rel="stylesheet" th:href="@{/css/product/product_list_style.css}">
</head>

<body>
<header>
    <div id="header" th:replace="~{layouts/header.html}"></div>
</header>
<main class="product-list-search">
    <section class="list-title">
        <h1>예적금 상품</h1>
        <span>다양한 예적금 상품을 비교하고 나에게 맞는 상품을 찾아보세요</span>
    </section>
    <section class="main-container">
        <article class="search-form">
            <div class="search-box">
                <form action="" method="get">
                    <input type="text" name="keyword" placeholder="상품명/키워드로 검색"/>
                </form>
            </div>
            <div class="keywords">
                <span class="label">추천 키워드:</span>
                <button>정기예금</button>
                <button>자유예금</button>
                <button>우대금리</button>
            </div>
        </article>
        <article class="list-content">
            <div class="wrap">
                <h2 style="margin:0 0 8px">총 상품 <span id="totalCount">0</span></h2>
                <div class="toolbar">
                    <div class="view-toggle">
                        <button id="btnGrid" class="active" aria-selected="true" title="그리드 보기">▦</button>
                        <button id="btnList" aria-selected="false" title="리스트 보기">☰</button>
                    </div>
                    <div class="sort">
                        <select id="sortSelect" aria-label="정렬">
                            <option value="join_internet">인터넷가입</option>
                            <option value="rate_desc">금리순</option>
                            <option value="release_desc">출시순</option>
                        </select>
                    </div>
                </div>
                <div id="chipFilters" class="filterChipbar" aria-label="검색 필터 (칩)"></div>
                <div id="container"></div>
                <div id="pagination" class="pagination" role="navigation" aria-label="페이지네이션"></div>
            </div>
            <script>
                /* ---- 예시 데이터 (백엔드 연동 시 이 부분을 API 응답으로 대체) ---- */
                // const PRODUCTS = [
                //     { id: 1, type: '정기예금', name: 'BNK 플러스 정기예금', baseRate: 3.5, bonusRate: 0.7, term: '6~36개월', join: ['인터넷', '영업점'], benefits: ['자동이체 +0.3%'], releasedAt: '2024-07-10' },
                //     { id: 2, type: '정기예금', name: 'BNK 프리미엄 정기예금', baseRate: 3.8, bonusRate: 0.7, term: '12~24개월', join: ['인터넷', '영업점'], benefits: ['급여이체 +0.5%'], releasedAt: '2024-10-15' },
                //     { id: 3, type: '정기예금', name: 'BNK 스마트 정기예금', baseRate: 3.3, bonusRate: 0.5, term: '3~12개월', join: ['인터넷'], benefits: ['모바일 가입 +0.2%'], releasedAt: '2024-05-30' },
                //     { id: 4, type: '정기예금', name: 'BNK 자유적립 정기예금', baseRate: 3.1, bonusRate: 0.5, term: '6~36개월', join: ['인터넷', '영업점'], benefits: ['자동이체 +0.3%'], releasedAt: '2023-12-20' },
                //     { id: 5, type: '정기예금', name: 'BNK 만기이자지급식 예금', baseRate: 3.4, bonusRate: 0.5, term: '12~24개월', join: ['인터넷', '영업점'], benefits: ['카드사용 +0.2%'], releasedAt: '2024-03-18' },
                //     { id: 6, type: '정기예금', name: 'BNK 정기예금(특판)', baseRate: 3.6, bonusRate: 0.9, term: '6~12개월', join: ['인터넷'], benefits: ['신규우대 +0.3%'], releasedAt: '2024-11-01' },
                //     { id: 7, type: '정기예금', name: 'BNK e-정기예금', baseRate: 3.2, bonusRate: 0.6, term: '12~36개월', join: ['인터넷'], benefits: ['자동이체 +0.3%'], releasedAt: '2022-09-10' },
                //     { id: 8, type: '정기예금', name: 'BNK 프리미엄Plus', baseRate: 3.7, bonusRate: 0.6, term: '3~24개월', join: ['영업점'], benefits: ['급여이체 +0.4%'], releasedAt: '2024-08-05' },
                //     { id: 9, type: '정기예금', name: 'BNK 스텝업예금', baseRate: 3.1, bonusRate: 0.7, term: '6~24개월', join: ['인터넷', '영업점'], benefits: ['잔액유지 +0.2%'], releasedAt: '2024-01-25' },
                // ].map(p => ({ ...p, maxRate: +(p.baseRate + p.bonusRate).toFixed(2) }));

                /* ================= 상태 ================= */
                let view = 'grid';               // 'grid' | 'list'
                let sortKey = 'join_internet';   // 서버가 지원하도록 맞춰 주세요
                let page = 1;
                const pageSize = 6;

                /* ================= DOM ================= */
                const container = document.getElementById('container');
                const pager = document.getElementById('pagination');
                const totalEl = document.getElementById('totalCount');

                /* ================= 칩(필터) 정의/렌더: 기존 그대로 사용 ================= */
                const CHIP_GROUPS = [
                    {
                        id: 'target', label: '가입대상', field: 'target', fieldType: 'scalar',
                        options: [
                            {value: '개인', label: '개인'},
                            {value: '기업', label: '기업'},
                            {value: '개인사업자', label: '개인사업자'},
                        ]
                    },
                    {
                        id: 'join', label: '가입방법', field: 'join', fieldType: 'array',
                        options: [
                            {value: '인터넷', label: '인터넷가입'},
                            {value: '스마트폰', label: '스마트폰가입'},
                            {value: '영업점', label: '영업점가입'},
                        ]
                    },
                    {
                        id: 'tax', label: '세제혜택', field: 'tax', fieldType: 'scalar',
                        options: [
                            {value: '비과세', label: '비과세'},
                            {value: '세금우대', label: '세금우대'},
                            {value: '소득공제', label: '소득공제'},
                        ]
                    },
                ];

                const chipSelections = Object.fromEntries(CHIP_GROUPS.map(g => [g.id, new Set(['__ALL__'])]));

                /* 칩 바 렌더 */
                function renderChipBar() {
                    const root = document.getElementById('chipFilters');
                    root.innerHTML = CHIP_GROUPS.map(g => `
                        <div class="Chip-group" data-group="${g.id}">
                          <div class="glabel">${g.label}</div>
                          <div class="Chip-row">
                            <button type="button"
                              class="Chip ${chipSelections[g.id].has('__ALL__') ? 'active' : ''}"
                              data-value="__ALL__">전체</button>
                            ${g.options.map(o => `
                              <button type="button"
                                class="Chip ${chipSelections[g.id].has(o.value) ? 'active' : ''}"
                                data-value="${o.value}">${o.label}</button>
                            `).join('')}
                          </div>
                        </div>
                      `).join('');

                    // 이벤트 바인딩
                    root.querySelectorAll('.Chip-group').forEach(groupEl => {
                        const gid = groupEl.dataset.group;
                        groupEl.querySelectorAll('.Chip').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const val = btn.dataset.value;
                                const set = chipSelections[gid];

                                if (val === '__ALL__') {
                                    chipSelections[gid] = new Set(['__ALL__']);
                                } else {
                                    set.delete('__ALL__');
                                    if (set.has(val)) set.delete(val); else set.add(val);
                                    if (set.size === 0) set.add('__ALL__');
                                }

                                renderChipBar();
                                page = 1;          // ★ 필터 바뀌면 1페이지
                                fetchProducts();   // ★ 서버에서 다시 조회
                            });
                        });
                    });
                }

                /* ================= 서버 호출 & 렌더 ================= */

                // 칩 선택 → 쿼리 파라미터로
                function buildFilterParams() {
                    const params = new URLSearchParams();
                    for (const g of CHIP_GROUPS) {
                        const set = chipSelections[g.id];
                        if (!set || set.has('__ALL__')) continue;
                        const values = Array.from(set);
                        if (values.length) params.append(g.id, values.join(','));
                    }
                    return params;
                }

                // 로딩 표시
                function setLoading(on) {
                    if (on) {
                        container.innerHTML = `
                          <div style="padding:24px;text-align:center;color:#6b7280">불러오는 중...</div>
                        `;
                    }
                }

                // ★ 서버에서 목록 받아오기
                async function fetchProducts() {
                    setLoading(true);

                    const qs = new URLSearchParams({
                        sort: sortKey,          // 예: 'join_internet' | 'rate_desc' | 'release_desc'
                        page: String(page),
                        pageSize: String(pageSize),
                    });
                    // 필터 추가
                    const filters = buildFilterParams();
                    filters.forEach((v, k) => qs.append(k, v));

                    try {
                        const res = await fetch(`/product/items?${qs.toString()}`, {method: 'GET'});
                        if (!res.ok) throw new Error('Server Error');
                        const data = await res.json(); // { items, total, page, pageSize }

                        // 총 개수
                        const total = data.total ?? 0;
                        const size = data.pageSize ?? pageSize;
                        totalEl.textContent = total;

                        // 렌더
                        const items = Array.isArray(data.items) ? data.items : [];
                        container.innerHTML = (view === 'grid') ? renderGrid(items) : renderList(items);

                        const totalPages = Math.max(1, Math.ceil(total / size));
                        renderPager(totalPages);
                    } catch (err) {
                        console.error(err);
                        container.innerHTML = `<div style="padding:24px;text-align:center;color:#ef4444">목록을 불러오지 못했습니다.</div>`;
                        pager.innerHTML = '';
                    }
                }

                /* 페이지네이션 */
                function renderPager(totalPages) {
                    const makeBtn = (label, p, disabled = false, active = false) => `
                        <button class="page-btn ${active ? 'active' : ''}" ${disabled ? 'disabled' : ''}
                          aria-label="페이지 ${label}" data-page="${p}">${label}</button>`;

                    let html = '';
                    html += makeBtn('〈', Math.max(1, page - 1), page === 1, false);

                    for (let i = 1; i <= totalPages; i++) {
                        html += makeBtn(String(i), i, false, i === page);
                    }

                    html += makeBtn('〉', Math.min(totalPages, page + 1), page === totalPages, false);
                    pager.innerHTML = html;

                    pager.querySelectorAll('.page-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const target = Number(e.currentTarget.dataset.page);
                            if (!isNaN(target) && target !== page) {
                                page = target;
                                fetchProducts(); // ★ 서버 재조회
                            }
                        });
                    });
                }

                /* ================= 카드/리스트 템플릿: 기존 그대로 ================= */
                function renderGrid(items) {
                    return `
                            <div class="grid">
                              ${items.map(p => `
                                <div class="card">
                                  <span class="badge">${p.ptype}</span>
                                  <div class="name">${p.pname}</div>
                                  <div class="rate-big">${p.phirate}%</div>
                                  <div class="meta">기본금리 ${Number(p.pbirate).toFixed(2)}%<br>계약기간: ${p.pcprd}</div>
                                  <div class="chips">
                                    ${(p.pprfcrt || []).map(b => `<span class="chip">${b}</span>`).join('')}
                                  </div>
                                  <div class="btns">
                                    <button class="btn btn-white">자세히</button>
                                    <button class="btn btn-red">신청하기</button>
                                  </div>
                                </div>
                              `).join('')}
                            </div>
                          `;
                }

                function renderList(items) {
                    return `
                            <div class="list-wrap">
                              <div class="table">
                                <div class="thead">
                                  <div class="cell">상품명</div>
                                  <div class="cell">기본금리</div>
                                  <div class="cell">최고금리</div>
                                  <div class="cell">계약기간</div>
                                  <div class="cell">가입방법</div>
                                  <div class="cell">우대조건</div>
                                  <div class="cell">신청</div>
                                </div>
                                ${items.map(p => `
                                  <div class="trow">
                                    <div class="cell name-col">
                                      <div>
                                        <div class="title">${p.pname}</div>
                                        <div class="subtitle">안정적인 고금리 정기예금</div>
                                      </div>
                                    </div>
                                    <div class="cell rate-col">
                                      <span class="rate-base">${Number(p.pbirate).toFixed(2)}</span>
                                      <span class="rate-suffix">%</span>
                                    </div>
                                    <div class="cell rate-col">
                                      <span class="rate-max">${Number(p.phirate).toFixed(2)}</span>
                                      <span class="rate-suffix">%</span>
                                    </div>
                                    <div class="cell"><span class="term">${p.pcprd}</span></div>
                                    <div class="cell">
                                      <div class="method">
                                        ${(p.join || []).map(j => `<span class="badge-soft">${j}</span>`).join('')}
                                      </div>
                                    </div>
                                    <div class="cell">
                                      <div class="benefits">
                                        ${(p.pprfcrt || []).map(b => `<span class="badge-green">${b}</span>`).join('')}
                                      </div>
                                    </div>
                                    <div class="cell btn-apply">
                                      <button class="btn btn-red">신청하기</button>
                                    </div>
                                  </div>
                                `).join('')}
                              </div>
                            </div>
                          `;
                }

                /* ================= 이벤트 바인딩 ================= */
                document.getElementById('btnGrid').onclick = () => {
                    view = 'grid';
                    document.getElementById('btnGrid').classList.add('active');
                    document.getElementById('btnList').classList.remove('active');
                    fetchProducts();
                };
                document.getElementById('btnList').onclick = () => {
                    view = 'list';
                    document.getElementById('btnList').classList.add('active');
                    document.getElementById('btnGrid').classList.remove('active');
                    fetchProducts();
                };
                document.getElementById('sortSelect').onchange = (e) => {
                    sortKey = e.target.value;  // 'join_internet' | 'rate_desc' | 'release_desc' 등
                    page = 1;
                    fetchProducts();
                };

                /* ================= 초기 로드 ================= */
                renderChipBar();
                fetchProducts();

            </script>
        </article>
    </section>
    <section class="notice-box" role="region" aria-label="예금 상품 안내사항">
        <div class="notice-icon" aria-hidden="true">
            <!-- 빨간 동그라미 느낌표 아이콘 -->
            <svg width="16" height="16" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="11" fill="#dc2626"/>
                <rect x="11" y="6" width="2" height="9" rx="1" fill="#fff"/>
                <circle cx="12" cy="18" r="1.5" fill="#fff"/>
            </svg>
        </div>
        <div class="notice-body">
            <h3 class="notice-title">예금 상품 안내사항</h3>
            <ul class="notice-list">
                <li>예금자보호법에 따라 예금보험공사가 1인당 최고 5천만원까지 보호합니다.</li>
                <li>중도해지 시 약정금리보다 낮은 금리가 적용되어 불이익이 발생할 수 있습니다.</li>
                <li>우대금리는 조건 충족 시 제공되며, 세부 조건은 상품설명 참고합니다.</li>
                <li>금리는 시장상황에 따라 변동될 수 있으며, 가입 시점의 금리가 적용됩니다.</li>
            </ul>
        </div>
    </section>
</main>
<footer>
    <div id="footer" th:replace="~{layouts/footer.html}"></div>
</footer>
<div id="bnk-chatbot-container" style="position: fixed; right: 20px; bottom: 20px; z-index: 9999;">
    <div id="bnk-chatbot-slot" th:replace="~{components/chatbot_test.html}"></div>
</div>
</body>

</html>