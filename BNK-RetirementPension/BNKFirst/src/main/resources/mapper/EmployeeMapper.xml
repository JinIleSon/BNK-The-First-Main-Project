<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.bnkfirst.mapper.EmployeeMapper">

    <!-- ========================================================= -->
    <!-- ■ 직원 목록 조회                                          -->
    <!-- ========================================================= -->
    <select id="findAllEmployees"
            resultType="kr.co.bnkfirst.dto.corporate.employee.EmployeeListDto">
        SELECT
            EMPID AS empId,
            NAME AS name,
            PLANTYPE AS planType,
            ACCOUNTNO AS accountNo,
            STATUS AS status
        FROM EMPLOYEE
        ORDER BY EMPID
    </select>



    <!-- ========================================================= -->
    <!-- ■ 직원 상세 조회                                          -->
    <!-- ========================================================= -->
    <select id="findEmployeeById"
            parameterType="long"
            resultType="kr.co.bnkfirst.dto.corporate.employee.EmployeeDetailDto">
        SELECT
            EMPID AS empId,
            NAME AS name,
            PLANTYPE AS planType,
            ACCOUNTNO AS accountNo,
            STATUS AS status
        FROM EMPLOYEE
        WHERE EMPID = #{empId}
    </select>



    <!-- ========================================================= -->
    <!-- ■ 직원 월별 납입 내역 조회                                -->
    <!-- ========================================================= -->
    <select id="findContributionsByEmpId"
            parameterType="long"
            resultType="kr.co.bnkfirst.dto.corporate.employee.EmployeeContributionDto">
        SELECT
            EMPID AS empId,
            YEARMONTH AS yearMonth,
            AMOUNT AS amount
        FROM CONTRIBUTION
        WHERE EMPID = #{empId}
        ORDER BY TO_NUMBER(YEARMONTH)
    </select>



    <!-- ========================================================= -->
    <!-- ■ 전체 직원 수                                             -->
    <!-- ========================================================= -->
    <select id="getTotalEmployees" resultType="int">
        SELECT COUNT(*) FROM EMPLOYEE
    </select>



    <!-- ========================================================= -->
    <!-- ■ 직원 검색 (Oracle 최적화 버전)                           -->
    <!-- ========================================================= -->
    <select id="search"
            resultType="kr.co.bnkfirst.dto.corporate.employee.EmployeeListDto">

        SELECT
        EMPID AS empId,
        NAME AS name,
        PLANTYPE AS planType,
        ACCOUNTNO AS accountNo,
        STATUS AS status
        FROM EMPLOYEE

        <where>

            <!-- 이름 검색 -->
            <if test="keyword != null and keyword != ''">
                AND NAME LIKE '%' || #{keyword} || '%'
            </if>

            <!-- 제도(DB/DC) 필터 — ALL(전체)은 조건 제외 -->
            <if test="planType != null and planType != '' and planType != 'ALL'">
                AND PLANTYPE = #{planType}
            </if>

        </where>

        ORDER BY EMPID
    </select>



    <!-- ========================================================= -->
    <!-- ■ 직원 정보 수정 (UPDATE)                                 -->
    <!-- ========================================================= -->
    <update id="updateEmployee"
            parameterType="kr.co.bnkfirst.dto.corporate.employee.EmployeeUpdateDto">
        UPDATE EMPLOYEE
        SET
            NAME = #{name},
            PLANTYPE = #{planType},
            ACCOUNTNO = #{accountNo},
            STATUS = #{status}
        WHERE EMPID = #{empId}
    </update>




    <!-- ========================================================= -->
    <!-- ■ 직원 삭제 (DELETE)                                      -->
    <!-- ========================================================= -->
    <delete id="deleteEmployee" parameterType="long">
        DELETE FROM EMPLOYEE
        WHERE EMPID = #{empId}
    </delete>



    <!-- ========================================================= -->
    <!-- ■ 직원 현재 적립금 조회 (SUM)                             -->
    <!-- ========================================================= -->
    <select id="getCurrentBalance" parameterType="long" resultType="long">
        SELECT NVL(SUM(AMOUNT), 0)
        FROM CONTRIBUTION
        WHERE EMPID = #{empId}
    </select>


    <!-- ========================================================= -->
    <!-- ■ 직원 자동완성 (이름 / 사번 / 계좌번호 통합 검색)       -->
    <!-- ========================================================= -->
    <select id="autocomplete"
            parameterType="string"
            resultType="kr.co.bnkfirst.dto.corporate.employee.EmployeeListDto">

        SELECT
            EMPID AS empId,
            NAME AS name,
            PLANTYPE AS planType,
            ACCOUNTNO AS accountNo,
            STATUS AS status
        FROM EMPLOYEE
        WHERE
            NAME LIKE '%' || #{keyword} || '%'
           OR TO_CHAR(EMPID) LIKE '%' || #{keyword} || '%'
           OR ACCOUNTNO LIKE '%' || #{keyword} || '%'
        ORDER BY EMPID

    </select>

</mapper>
