<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.bnkfirst.mapper.EmployeeMapper">

    <!-- ========================================================= -->
    <!-- 직원 전체 목록 -->
    <!-- ========================================================= -->
    <select id="findAllEmployees"
            resultType="kr.co.bnkfirst.dto.corporate.employee.EmployeeListDto">
        SELECT
            EMPID       AS empId,
            NAME        AS name,
            PLANTYPE    AS planType,
            ACCOUNTNO   AS accountNo,
            STATUS      AS status
        FROM EMPLOYEE
        ORDER BY EMPID
    </select>


    <!-- ========================================================= -->
    <!-- 직원 상세 -->
    <!-- ========================================================= -->
    <select id="findEmployeeById"
            parameterType="long"
            resultType="kr.co.bnkfirst.dto.corporate.employee.EmployeeDetailDto">
        SELECT
            EMPID       AS empId,
            NAME        AS name,
            PLANTYPE    AS planType,
            ACCOUNTNO   AS accountNo,
            STATUS      AS status
        FROM EMPLOYEE
        WHERE EMPID = #{empId}
    </select>


    <!-- ========================================================= -->
    <!-- 직원 월별 납입 내역 -->
    <!-- ========================================================= -->
    <select id="findContributionsByEmpId"
            parameterType="long"
            resultType="kr.co.bnkfirst.dto.corporate.employee.EmployeeContributionDto">

        SELECT
            EMPID       AS empId,
            YEARMONTH   AS yearMonth,
            AMOUNT      AS amount
        FROM CONTRIBUTION
        WHERE EMPID = #{empId}
        ORDER BY TO_NUMBER(YEARMONTH)
    </select>


    <!-- ========================================================= -->
    <!-- 전체 직원 수 -->
    <!-- ========================================================= -->
    <select id="getTotalEmployees" resultType="int">
        SELECT COUNT(*) FROM EMPLOYEE
    </select>


    <!-- ========================================================= -->
    <!-- 검색 (이름 / 제도) -->
    <!-- ========================================================= -->
    <select id="search"
            resultType="kr.co.bnkfirst.dto.corporate.employee.EmployeeListDto">

        SELECT
        EMPID       AS empId,
        NAME        AS name,
        PLANTYPE    AS planType,
        ACCOUNTNO   AS accountNo,
        STATUS      AS status
        FROM EMPLOYEE

        <where>

            <if test="keyword != null and keyword != ''">
                AND NAME LIKE '%' || #{keyword} || '%'
            </if>

            <if test="planType != null and planType != '' and planType != 'ALL'">
                AND PLANTYPE = #{planType}
            </if>

        </where>

        ORDER BY EMPID
    </select>


    <!-- ========================================================= -->
    <!-- 직원 수정 -->
    <!-- ========================================================= -->
    <update id="updateEmployee"
            parameterType="kr.co.bnkfirst.dto.corporate.employee.EmployeeUpdateDto">
        UPDATE EMPLOYEE
        SET
            NAME        = #{name},
            PLANTYPE    = #{planType},
            ACCOUNTNO   = #{accountNo},
            STATUS      = #{status}
        WHERE EMPID = #{empId}
    </update>


    <!-- ========================================================= -->
    <!-- 직원 삭제 -->
    <!-- ========================================================= -->
    <delete id="deleteEmployee"
            parameterType="long">
        DELETE FROM EMPLOYEE
        WHERE EMPID = #{empId}
    </delete>


    <!-- ========================================================= -->
    <!-- 직원 현재 적립금 -->
    <!-- ========================================================= -->
    <select id="getCurrentBalance"
            parameterType="long"
            resultType="long">
        SELECT NVL(SUM(AMOUNT), 0)
        FROM CONTRIBUTION
        WHERE EMPID = #{empId}
    </select>


    <!-- ========================================================= -->
    <!-- ⭐ 자동완성 (최적화 + 성능향상 + 초성검색(ㄱㅁ) 지원) -->
    <!-- ========================================================= -->

    <!-- 초성 변환 함수 정의부
         - Oracle에서는 직접 구현해야 하므로 NVL + REGEXP 사용
         - ㅅㅈ → '세준', '성진'도 검색 가능하게 설계
    -->

    <select id="autocomplete"
            parameterType="string"
            resultType="kr.co.bnkfirst.dto.corporate.employee.EmployeeAutoDto">

        SELECT
            EMPID       AS empId,
            NAME        AS name,
            ACCOUNTNO   AS accountNo
        FROM EMPLOYEE

        WHERE
            (
                -- 1) 이름 직접 검색
                LOWER(NAME) LIKE LOWER('%' || #{keyword} || '%')

                    -- 2) 사번 검색
                    OR TO_CHAR(EMPID) LIKE '%' || #{keyword} || '%'

                    -- 3) 계좌번호 검색
                    OR ACCOUNTNO LIKE '%' || #{keyword} || '%'

                    -- ⭐ 4) 초성 검색(ㄱㅁ → 김민수, 고명섭 등)
                    OR REGEXP_LIKE(NAME, fn_convert_chosung(#{keyword}))
                )

        ORDER BY EMPID
    </select>

</mapper>
