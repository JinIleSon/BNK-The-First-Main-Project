<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상품 목록(검색)</title>
    <link rel="stylesheet" href="product_list_style.css">
</head>

<body>
    <header>
        <div id="header"></div>
    </header>
    <main class="product-list-search">
        <section class="list-title">
            <h1>예적금 상품</h1>
            <span>다양한 예적금 상품을 비교하고 나에게 맞는 상품을 찾아보세요</span>
        </section>
        <section class="main-container">
            <article class="search-form">
                <div class="search-box">
                    <form action="" method="get">
                        <input type="text" name="keyword" placeholder="상품명/키워드로 검색" />
                    </form>
                </div>
                <div class="keywords">
                    <span class="label">추천 키워드:</span>
                    <button>정기예금</button>
                    <button>자유예금</button>
                    <button>우대금리</button>
                </div>
            </article>
            <article class="list-content">
                <div class="wrap">
                    <h2 style="margin:0 0 8px">총 상품 <span id="totalCount">0</span></h2>
                    <div class="toolbar">
                        <div class="view-toggle">
                            <button id="btnGrid" class="active" aria-selected="true" title="그리드 보기">▦</button>
                            <button id="btnList" aria-selected="false" title="리스트 보기">☰</button>
                        </div>
                        <div class="sort">
                            <select id="sortSelect" aria-label="정렬">
                                <option value="rate_desc">금리높은순</option>
                                <option value="rate_asc">금리낮은순</option>
                                <option value="name_asc">이름순</option>
                            </select>
                        </div>
                    </div>
                    <div id="chipFilters" class="filterChipbar" aria-label="검색 필터 (칩)"></div>
                    <div id="container"></div>
                    <div id="pagination" class="pagination" role="navigation" aria-label="페이지네이션"></div>
                </div>
                <script>
                    /* ---- 예시 데이터 (백엔드 연동 시 이 부분을 API 응답으로 대체) ---- */
                    const PRODUCTS = [
                        { id: 1, type: '정기예금', name: 'BNK 플러스 정기예금', baseRate: 3.5, bonusRate: 0.7, term: '6~36개월', join: ['인터넷', '영업점'], benefits: ['자동이체 +0.3%'] },
                        { id: 2, type: '정기예금', name: 'BNK 프리미엄 정기예금', baseRate: 3.8, bonusRate: 0.7, term: '12~24개월', join: ['인터넷', '영업점'], benefits: ['급여이체 +0.5%'] },
                        { id: 3, type: '정기예금', name: 'BNK 스마트 정기예금', baseRate: 3.3, bonusRate: 0.5, term: '3~12개월', join: ['인터넷'], benefits: ['모바일 가입 +0.2%'] },
                        { id: 4, type: '정기예금', name: 'BNK 자유적립 정기예금', baseRate: 3.1, bonusRate: 0.5, term: '6~36개월', join: ['인터넷', '영업점'], benefits: ['자동이체 +0.3%'] },
                        { id: 5, type: '정기예금', name: 'BNK 만기이자지급식 예금', baseRate: 3.4, bonusRate: 0.5, term: '12~24개월', join: ['인터넷', '영업점'], benefits: ['카드사용 +0.2%'] },
                        { id: 6, type: '정기예금', name: 'BNK 정기예금(특판)', baseRate: 3.6, bonusRate: 0.9, term: '6~12개월', join: ['인터넷'], benefits: ['신규우대 +0.3%'] },
                        { id: 7, type: '정기예금', name: 'BNK e-정기예금', baseRate: 3.2, bonusRate: 0.6, term: '12~36개월', join: ['인터넷'], benefits: ['자동이체 +0.3%'] },
                        { id: 8, type: '정기예금', name: 'BNK 프리미엄Plus', baseRate: 3.7, bonusRate: 0.6, term: '3~24개월', join: ['영업점'], benefits: ['급여이체 +0.4%'] },
                        { id: 9, type: '정기예금', name: 'BNK 스텝업예금', baseRate: 3.1, bonusRate: 0.7, term: '6~24개월', join: ['인터넷', '영업점'], benefits: ['잔액유지 +0.2%'] },
                    ].map(p => ({ ...p, maxRate: +(p.baseRate + p.bonusRate).toFixed(2) }));

                    /* ================= 상태 ================= */
                    let view = 'grid';         // 'grid' | 'list'
                    let sortKey = 'rate_desc'; // 정렬 키
                    let page = 1;
                    const pageSize = 6;

                    /* ================= 유틸 ================= */
                    function sortItems(items, key) {
                        const cp = [...items];
                        switch (key) {
                            case 'rate_desc': cp.sort((a, b) => b.maxRate - a.maxRate); break;
                            case 'rate_asc': cp.sort((a, b) => a.maxRate - b.maxRate); break;
                            case 'name_asc': cp.sort((a, b) => a.name.localeCompare(b.name, 'ko')); break;
                        }
                        return cp;
                    }
                    // 페이지당 size(여기서는 6)개씩 보이게
                    function paginate(items, p, size) {
                        const start = (p - 1) * size;
                        return items.slice(start, start + size);
                    }

                    /* ================= 렌더 ================= */
                    const container = document.getElementById('container');
                    const pager = document.getElementById('pagination');

                    function render() {
                        const sorted = sortItems(PRODUCTS, sortKey);
                        const total = sorted.length;
                        const totalPages = Math.max(1, Math.ceil(total / pageSize));
                        if (page > totalPages) page = totalPages;

                        const pageItems = paginate(sorted, page, pageSize);

                        container.innerHTML = (view === 'grid')
                            ? renderGrid(pageItems)
                            : renderList(pageItems);

                        renderPager(totalPages);
                    }

                    // 그리드 형일 때, 카드 html
                    function renderGrid(items) {
                        return `
                                <div class="grid">
                                ${items.map(p => `
                                    <div class="card">
                                    <span class="badge">${p.type}</span>
                                    <div class="name">${p.name}</div>
                                    <div class="rate-big">${p.maxRate}%</div>
                                    <div class="meta">기본금리 ${p.baseRate.toFixed(2)}% + 우대금리 ${p.bonusRate.toFixed(2)}%<br>계약기간: ${p.term}</div>
                                    <div class="chips">
                                        ${p.benefits.map(b => `<span class="chip">${b}</span>`).join('')}
                                    </div>
                                    <div class="btns">
                                        <button class="btn btn-white">자세히</button>
                                        <button class="btn btn-red">신청하기</button>
                                    </div>
                                    </div>
                                `).join('')}
                                </div>
                            `;
                    }

                    // 리스트 형일 때, 행 html
                    function renderList(items) {
                        return `
                                <div class="list-wrap">
                                <div class="table">
                                    <div class="thead">
                                    <div class="cell">상품명</div>
                                    <div class="cell">기본금리</div>
                                    <div class="cell">최고금리</div>
                                    <div class="cell">계약기간</div>
                                    <div class="cell">가입방법</div>
                                    <div class="cell">우대조건</div>
                                    <div class="cell">신청</div>
                                    </div>
                                    ${items.map(p => `
                                    <div class="trow">
                                        <div class="cell name-col">
                                        <div>
                                            <div class="title">${p.name}</div>
                                            <div class="subtitle">안정적인 고금리 정기예금</div>
                                        </div>
                                        </div>
                                        <div class="cell rate-col">
                                        <span class="rate-base">${p.baseRate.toFixed(2)}</span>
                                        <span class="rate-suffix">%</span>
                                        </div>
                                        <div class="cell rate-col">
                                        <span class="rate-max">${p.maxRate.toFixed(2)}</span>
                                        <span class="rate-suffix">%</span>
                                        </div>
                                        <div class="cell"><span class="term">${p.term}</span></div>
                                        <div class="cell">
                                        <div class="method">
                                            ${p.join.map(j => `<span class="badge-soft">${j}</span>`).join('')}
                                        </div>
                                        </div>
                                        <div class="cell">
                                        <div class="benefits">
                                            ${p.benefits.map(b => `<span class="badge-green">${b}</span>`).join('')}
                                        </div>
                                        </div>
                                        <div class="cell btn-apply">
                                        <button class="btn btn-red">신청하기</button>
                                        </div>
                                    </div>
                                    `).join('')}
                                </div>
                                </div>
                            `;
                    }

                    // 페이지네이션 생성 및 동작
                    function renderPager(totalPages) {
                        const makeBtn = (label, p, disabled = false, active = false) => `
                            <button class="page-btn ${active ? 'active' : ''}" ${disabled ? 'disabled' : ''}
                            aria-label="페이지 ${label}" data-page="${p}">${label}</button>`;

                        let html = '';
                        // 이전
                        html += makeBtn('〈', Math.max(1, page - 1), page === 1, false);
                        // 숫자
                        for (let i = 1; i <= totalPages; i++) {
                            html += makeBtn(String(i), i, false, i === page);
                        }
                        // 다음
                        html += makeBtn('〉', Math.min(totalPages, page + 1), page === totalPages, false);
                        pager.innerHTML = html;

                        // 이벤트 바인딩
                        pager.querySelectorAll('.page-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const target = Number(e.currentTarget.dataset.page);
                                if (!isNaN(target) && target !== page) {
                                    page = target;
                                    render();
                                }
                            });
                        });
                    }

                    /* ================= 이벤트 ================= */
                    // 그리드/리스트 형 변환
                    document.getElementById('btnGrid').onclick = () => {
                        view = 'grid';
                        document.getElementById('btnGrid').classList.add('active');
                        document.getElementById('btnList').classList.remove('active');
                        render();
                    };
                    document.getElementById('btnList').onclick = () => {
                        view = 'list';
                        document.getElementById('btnList').classList.add('active');
                        document.getElementById('btnGrid').classList.remove('active');
                        render();
                    };
                    document.getElementById('sortSelect').onchange = (e) => {
                        sortKey = e.target.value;
                        page = 1; // 정렬 변경 시 첫 페이지로
                        render();
                    };

                    /* === 칩 그룹 정의 ===
                    * fieldType: 'scalar' | 'array'  (상품 데이터에서 단일값/배열 여부)
                    * 옵션 라벨은 자유롭게 수정 가능
                    * value : 실제 비교값, label : 표시 글자, field : 테이블 열 이름
                    */
                    const CHIP_GROUPS = [
                        {
                            id: 'target', label: '가입대상', field: 'target', fieldType: 'scalar',
                            options: [
                                { value: '개인', label: '개인' },
                                { value: '기업', label: '기업' },
                                { value: '개인사업자', label: '개인사업자' },
                            ]
                        },
                        {
                            id: 'join', label: '가입방법', field: 'join', fieldType: 'array',
                            options: [
                                { value: '인터넷', label: '인터넷가입' },
                                { value: '스마트폰', label: '스마트폰가입' },
                                { value: '영업점', label: '영업점가입' },
                            ]
                        },
                        {
                            id: 'tax', label: '세제혜택', field: 'tax', fieldType: 'scalar',
                            options: [
                                { value: '비과세', label: '비과세' },
                                { value: '세금우대', label: '세금우대' },
                                { value: '소득공제', label: '소득공제' },
                            ]
                        },
                    ];

                    /* 초기 선택 상태: 각 그룹은 '전체'만 활성 */
                    const chipSelections = Object.fromEntries(
                        CHIP_GROUPS.map(g => [g.id, new Set(['__ALL__'])])
                    );

                    /* 칩 렌더링 */
                    function renderChipBar() {
                        const root = document.getElementById('chipFilters');
                        root.innerHTML = CHIP_GROUPS.map(g => `
                            <div class="Chip-group" data-group="${g.id}">
                            <div class="glabel">${g.label}</div>
                            <div class="Chip-row">
                                <button type="button"
                                class="Chip ${chipSelections[g.id].has('__ALL__') ? 'active' : ''}"
                                data-value="__ALL__">전체</button>
                                ${g.options.map(o => `
                                <button type="button"
                                    class="Chip ${chipSelections[g.id].has(o.value) ? 'active' : ''}"
                                    data-value="${o.value}">${o.label}</button>
                                `).join('')}
                            </div>
                            </div>
                        `).join('');

                        // 이벤트 바인딩
                        root.querySelectorAll('.Chip-group').forEach(groupEl => {
                            /*
                            * groupEl.dataset은 그 요소의 모든 data- 속성을 객체로 반환
                            * groupEl.dataset.group == groupEl.getAttribute('data-group')
                            */
                            const gid = groupEl.dataset.group;
                            groupEl.querySelectorAll('.Chip').forEach(btn => {
                                btn.addEventListener('click', () => {
                                    const val = btn.dataset.value;
                                    const set = chipSelections[gid];

                                    if (val === '__ALL__') {
                                        // 전체 선택 → 해당 그룹 클리어 후 전체만
                                        chipSelections[gid] = new Set(['__ALL__']);
                                    } else {
                                        // '전체' 해제
                                        set.delete('__ALL__');
                                        // 토글
                                        if (set.has(val)) set.delete(val); else set.add(val);
                                        // 전부 해제되면 전체 복귀
                                        if (set.size === 0) set.add('__ALL__');
                                    }

                                    renderChipBar();
                                    page = 1;     // 페이지 초기화
                                    render();     // 목록 재랜더
                                });
                            });
                        });
                    }

                    /* 칩 필터 적용 (AND: 그룹 간 교집합 / OR: 그룹 내부 합집합) */
                    function applyChipFilters(items) {
                        return items.filter(p => {
                            return CHIP_GROUPS.every(g => {
                                const sel = chipSelections[g.id];
                                if (sel.has('__ALL__')) return true; // 이 그룹은 필터 미적용

                                const selectedValues = Array.from(sel);

                                if (g.fieldType === 'array') { // 여러 값; 필터와 하나라도 같은 게 있으면 보이기
                                    const arr = Array.isArray(p[g.field]) ? p[g.field] : [];
                                    return selectedValues.some(v => arr.includes(v));
                                } else { // scalar; 단일 값; 일치하는 것만 보이기
                                    const val = p[g.field];
                                    return selectedValues.includes(val);
                                }
                            });
                        });
                    }

                    /* 기존 render()에 필터 주입: 정렬/페이징 전에 호출 */
                    const _render = render;
                    render = function () {
                        // 1) 칩필터 → 2) 정렬 → 3) 페이징 → 4) 렌더
                        const filtered = applyChipFilters(PRODUCTS);
                        const sorted = sortItems(filtered, sortKey);
                        const total = sorted.length;
                        document.getElementById('totalCount').textContent = total;

                        const totalPages = Math.max(1, Math.ceil(total / pageSize));
                        if (page > totalPages) page = totalPages;

                        const pageItems = paginate(sorted, page, pageSize);
                        container.innerHTML = (view === 'grid') ? renderGrid(pageItems) : renderList(pageItems);
                        renderPager(totalPages);
                    };

                    /* 초기 렌더 */
                    renderChipBar();
                    render();
                </script>
            </article>
        </section>
        <section class="notice-box" role="region" aria-label="예금 상품 안내사항">
            <div class="notice-icon" aria-hidden="true">
                <!-- 빨간 동그라미 느낌표 아이콘 -->
                <svg width="16" height="16" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="11" fill="#dc2626" />
                    <rect x="11" y="6" width="2" height="9" rx="1" fill="#fff" />
                    <circle cx="12" cy="18" r="1.5" fill="#fff" />
                </svg>
            </div>
            <div class="notice-body">
                <h3 class="notice-title">예금 상품 안내사항</h3>
                <ul class="notice-list">
                    <li>예금자보호법에 따라 예금보험공사가 1인당 최고 5천만원까지 보호합니다.</li>
                    <li>중도해지 시 약정금리보다 낮은 금리가 적용되어 불이익이 발생할 수 있습니다.</li>
                    <li>우대금리는 조건 충족 시 제공되며, 세부 조건은 상품설명 참고합니다.</li>
                    <li>금리는 시장상황에 따라 변동될 수 있으며, 가입 시점의 금리가 적용됩니다.</li>
                </ul>
            </div>
        </section>
    </main>
    <footer>
        <div id="footer"></div>
    </footer>
    <div id="bnk-chatbot-container" style="position: fixed; right: 20px; bottom: 20px; z-index: 9999;">
        <div id="bnk-chatbot-slot"></div>
    </div>
</body>

</html>
<script>
    // header 불러오기
    fetch('/layouts/header.html')
        .then(response => response.text())
        .then(data => {
            console.log(data);

            document.getElementById('header').innerHTML = data;
        });
</script>
<script>
    /**
    * 외부 HTML을 불러와서:
    *  - <link rel="stylesheet">, <style>는 <head>로 옮기고
    *  - <script>는 실행되도록 새로 만들어 붙이고 (src/inline, module 모두 지원)
    *  - 나머지 DOM(예: <flowise-chatbot> / <flowise-embed>)은 mount에 삽입
    */
    async function importHtmlWithAssets(url, mountSelector) {
        const res = await fetch(url, { credentials: 'same-origin' });
        if (!res.ok) throw new Error(`Failed to load ${url}`);
        const html = await res.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // 1) <link rel="stylesheet"> 들을 <head>로
        doc.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
            // 중복 로드 방지
            const href = link.getAttribute('href');
            if (href && ![...document.head.querySelectorAll('link[rel="stylesheet"]')]
                .some(l => l.getAttribute('href') === href)) {
                document.head.appendChild(link.cloneNode(true));
            }
        });

        // 2) <style> 들을 <head>로
        doc.querySelectorAll('style').forEach(styleEl => {
            const clone = document.createElement('style');
            // CSS 텍스트 보존
            clone.textContent = styleEl.textContent;
            // (가능한 속성 복사)
            [...styleEl.attributes].forEach(a => clone.setAttribute(a.name, a.value));
            document.head.appendChild(clone);
        });

        // 3) 본문 콘텐츠를 mount에 붙임 (스크립트 제외)
        const mount = document.querySelector(mountSelector);
        // fragment 구성
        const frag = document.createDocumentFragment();
        [...doc.body.children].forEach(node => {
            if (node.tagName.toLowerCase() !== 'script') frag.appendChild(node.cloneNode(true));
        });
        mount.appendChild(frag);

        // 4) 스크립트 실행 (src/inline/module 지원, 순서 보장)
        const scripts = [...doc.querySelectorAll('script')];
        for (const oldScript of scripts) {
            const newScript = document.createElement('script');
            // type/module/defer 등 속성 복사
            [...oldScript.attributes].forEach(attr => newScript.setAttribute(attr.name, attr.value));
            if (oldScript.src) {
                // 네트워크 로드를 기다려 실행 순서 유지
                await new Promise((resolve, reject) => {
                    newScript.onload = resolve;
                    newScript.onerror = resolve;   // 실패해도 진행(브랜딩 제거 같은 선택 기능 보호)
                    document.body.appendChild(newScript);
                });
            } else {
                // inline 코드 복사
                newScript.textContent = oldScript.textContent || '';
                document.body.appendChild(newScript);
            }
        }
    }

    // 실제 호출: 기존 chatbot.html(또는 chatbot_test.html) 경로로 바꿔도 됩니다.
    importHtmlWithAssets('/components/chatbot_test.html', '#bnk-chatbot-slot')
        .catch(err => console.error('[Chatbot load failed]', err));
</script>
<script>
    // footer 불러오기
    fetch('/layouts/footer.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('footer').innerHTML = data;
        });
</script>